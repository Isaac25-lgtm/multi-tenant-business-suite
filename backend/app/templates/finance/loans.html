{% extends "base.html" %}

{% block title %}Loans - Denove APS{% endblock %}

{% block page_header %}
<h2>Individual Loans</h2>
<p>{{ loans|length }} loans</p>
{% endblock %}

{% block content %}
<div class="flex justify-end mb-6">
    <button onclick="showModal('add-loan-modal')" class="btn btn-primary">New Loan</button>
</div>

<!-- Quick Tip -->
{% if clients|length == 0 %}
<div class="quick-tip mb-6">
    <div class="quick-tip-title">No Clients Found!</div>
    You need to <a href="{{ url_for('finance.clients') }}" class="text-blue-600 underline font-medium">add a client first</a> before you can issue a loan.
</div>
{% else %}
<div class="guideline mb-6">
    <div class="font-semibold text-gray-700 mb-2">Data Entry Guide - Individual Loans</div>
    <ul class="list-disc list-inside space-y-1 text-sm">
        <li><strong>Step 1:</strong> Click "New Loan" to start - select a client from the list</li>
        <li><strong>Step 2:</strong> Enter principal amount, interest rate (%), and duration in weeks or months</li>
        <li><strong>Step 3:</strong> Click "Preview Agreement" to review all calculations before issuing</li>
        <li><strong>Step 4:</strong> Upload any collateral documents in the preview screen</li>
        <li><strong>Step 5:</strong> Click "Issue Loan" to finalize</li>
        <li><strong>Payments:</strong> Click "View" on any loan to record payments</li>
    </ul>
</div>
{% endif %}

<!-- Loans Table -->
<div class="section-card">
    <div class="section-card-header">
        <h2 class="section-card-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            All Loans
        </h2>
    </div>
    <div class="overflow-x-auto">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th class="text-right">Principal</th>
                    <th class="text-right">Interest</th>
                    <th class="text-right">Total</th>
                    <th class="text-right">Balance</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th style="min-width: 160px; white-space: nowrap;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in loans %}
                <tr>
                    <td class="font-medium">{{ loan.client.name }}</td>
                    <td class="text-right">{{ "{:,.0f}".format(loan.principal) }}</td>
                    <td class="text-right">{{ "{:.1f}".format(loan.interest_rate) }}%</td>
                    <td class="text-right">{{ "{:,.0f}".format(loan.total_amount) }}</td>
                    <td class="text-right {% if loan.balance > 0 %}text-orange-600{% else %}text-green-600{% endif %}">{{ "{:,.0f}".format(loan.balance) }}</td>
                    <td>{{ loan.due_date.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if loan.status == 'paid' %}
                        <span class="badge badge-success">Paid</span>
                        {% elif loan.status == 'overdue' %}
                        <span class="badge badge-danger">Overdue</span>
                        {% else %}
                        <span class="badge badge-info">Active</span>
                        {% endif %}
                    </td>
                    <td style="white-space: nowrap;">
                        <a href="{{ url_for('finance.view_loan', id=loan.id) }}" style="color:var(--terra-600);" class=" hover:underline text-sm">View</a>
                        {% if loan.status == 'active' and loan.balance > 0 %}
                        <button type="button" onclick="openRenewModal({{ loan.id }}, '{{ loan.client.name|e }}', {{ loan.principal }}, {{ loan.interest_rate }}, {{ loan.duration_weeks }}, {{ loan.total_amount - loan.principal }}, '{{ loan.duration_type or 'weeks' }}')" class="text-blue-600 hover:underline text-sm ml-2">Renew</button>
                        {% endif %}
                        {% if current_section == 'manager' %}
                        <a href="{{ url_for('finance.edit_loan', id=loan.id) }}" class="text-green-600 hover:underline text-sm ml-2">Edit</a>
                        {% endif %}
                        <form method="POST" action="{{ url_for('finance.delete_loan', id=loan.id) }}" class="inline" onsubmit="return confirm('Delete this loan?')">
                            <button type="submit" class="text-red-600 hover:underline text-sm ml-2">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center text-gray-500 py-8">
                        No loans found. Click "New Loan" to create one.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Loan Modal -->
<div id="add-loan-modal" class="modal">
    <div class="modal-content">
        <h3 class="text-lg font-semibold mb-4">New Loan</h3>
        {% if clients|length == 0 %}
        <div class="quick-tip mb-4">
            <div class="quick-tip-title">No Clients Available</div>
            <a href="{{ url_for('finance.clients') }}" class="text-blue-600 underline">Add a client first</a> before creating a loan.
        </div>
        <button type="button" onclick="hideModal('add-loan-modal')" class="btn btn-secondary w-full">Close</button>
        {% else %}
        <div class="guideline mb-4">
            <strong>Required:</strong> Select a client, enter principal amount, interest rate, and loan duration.
        </div>
        <form method="POST" action="{{ url_for('finance.preview_loan_agreement') }}">
            <div class="form-group">
                <label class="form-label">Client *</label>
                <select name="client_id" required class="form-select searchable-select">
                    <option value="">-- Select Client --</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.name }} ({{ client.phone }})</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Don't see your client? <a href="{{ url_for('finance.clients') }}" style="color:var(--terra-600);" class="">Add them first</a></p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Principal Amount *</label>
                    <input type="number" name="principal" min="1" step="0.01" required class="form-input" placeholder="e.g., 500000">
                </div>
                <div class="form-group">
                    <label class="form-label">Interest Rate (%)</label>
                    <input type="number" name="interest_rate" min="0" step="0.01" value="10" class="form-input">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="form-group">
                    <label class="form-label">Duration *</label>
                    <input type="number" name="duration_weeks" min="1" required class="form-input" placeholder="e.g., 4">
                </div>
                <div class="form-group">
                    <label class="form-label">Period</label>
                    <select name="duration_type" class="form-select">
                        <option value="weeks">Weeks</option>
                        <option value="months">Months</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Issue Date</label>
                    <input type="date" name="issue_date" value="{{ today }}" class="form-input date-restricted-input">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="hideModal('add-loan-modal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Preview Agreement</button>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<!-- Renew Loan Modal -->
<div id="renew-loan-modal" class="modal">
    <div class="modal-content">
        <h3 class="text-lg font-semibold mb-4">Renew Loan</h3>
        <form id="renew-loan-form" method="POST">
            <div class="guideline mb-4">
                <strong>Renewing loan for: </strong><span id="renew-client-name" class="font-semibold"></span><br>
                <span class="text-sm text-gray-600">Interest of <strong id="renew-interest-display"></strong> will be recorded as paid on the old loan. A new loan will be created with the terms below.</span>
            </div>

            <div class="section-card mb-4" style="padding: 12px; background: var(--gray-50);">
                <div class="font-semibold text-sm text-gray-600 mb-2">Previous Loan Terms</div>
                <div class="grid grid-cols-3 gap-2 text-sm">
                    <div>Principal: <strong id="renew-old-principal"></strong></div>
                    <div>Rate: <strong id="renew-old-rate"></strong>%</div>
                    <div>Duration: <strong id="renew-old-weeks"></strong> weeks</div>
                </div>
            </div>

            <div class="font-semibold text-sm text-gray-700 mb-2">New Loan Terms</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Principal Amount *</label>
                    <input type="number" name="principal" id="renew-principal" min="1" step="0.01" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Interest Rate (%) *</label>
                    <input type="number" name="interest_rate" id="renew-rate" min="0" step="0.01" required class="form-input">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Duration *</label>
                    <input type="number" name="duration_weeks" id="renew-weeks" min="1" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Period</label>
                    <select name="duration_type" id="renew-duration-type" class="form-select">
                        <option value="weeks">Weeks</option>
                        <option value="months">Months</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="hideModal('renew-loan-modal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Confirm Renewal</button>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize date restrictions based on user role
document.addEventListener('DOMContentLoaded', function() {
    const isManager = '{{ current_section }}' === 'manager';
    initDateRestrictions(isManager);
});

function openRenewModal(loanId, clientName, principal, rate, weeks, interestOwed, durationType) {
    document.getElementById('renew-loan-form').action = '/finance/loans/' + loanId + '/renew';
    document.getElementById('renew-client-name').textContent = clientName;
    document.getElementById('renew-interest-display').textContent = Number(interestOwed).toLocaleString('en', {maximumFractionDigits: 0});

    // Show previous terms
    document.getElementById('renew-old-principal').textContent = Number(principal).toLocaleString('en', {maximumFractionDigits: 0});
    document.getElementById('renew-old-rate').textContent = rate;
    document.getElementById('renew-old-weeks').textContent = weeks + ' ' + (durationType || 'weeks');

    // Pre-fill new terms with same values (editable)
    document.getElementById('renew-principal').value = principal;
    document.getElementById('renew-rate').value = rate;
    document.getElementById('renew-weeks').value = weeks;
    document.getElementById('renew-duration-type').value = durationType || 'weeks';

    showModal('renew-loan-modal');
}
</script>
{% endblock %}
