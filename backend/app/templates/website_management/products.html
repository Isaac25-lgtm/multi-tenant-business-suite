{% extends "base.html" %}
{% block title %}Publish Products ‚Äî Devs APS{% endblock %}

{% block page_header %}
<h1 class="page-title">üì¶ Publish Products to Website</h1>
<p class="page-subtitle">Control which products from your inventory appear on the public website</p>
{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('website.dashboard') }}" class="text-primary text-sm">‚Üê Back to Website Management</a>
</div>

<!-- How It Works Guide -->
<div class="card mb-8"
    style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9;">
    <div class="card-body">
        <h3 style="color: #0369a1; margin-bottom: 12px;">üí° How Publishing Works</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; margin-bottom: 8px;">1Ô∏è‚É£</div>
                <p style="font-weight: 600; margin-bottom: 4px;">Select a Product</p>
                <p style="font-size: 13px; color: #64748b;">Find an item from your Boutique or Hardware inventory below
                </p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; margin-bottom: 8px;">2Ô∏è‚É£</div>
                <p style="font-weight: 600; margin-bottom: 4px;">Ensure It Has an Image</p>
                <p style="font-size: 13px; color: #64748b;">Upload the correct image via Edit Stock Item first</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; margin-bottom: 8px;">3Ô∏è‚É£</div>
                <p style="font-weight: 600; margin-bottom: 4px;">Set Public Price</p>
                <p style="font-size: 13px; color: #64748b;">Optionally set a different price for the website</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; margin-bottom: 8px;">4Ô∏è‚É£</div>
                <p style="font-weight: 600; margin-bottom: 4px;">Publish!</p>
                <p style="font-size: 13px; color: #64748b;">The product now appears on your public website</p>
            </div>
        </div>
    </div>
</div>

<!-- Currently Published Products (LIVE) -->
<div class="card mb-8">
    <div class="card-header" style="background: #f0fdf4; border-bottom: 1px solid #86efac;">
        <h3 style="color: #166534;">‚úÖ Live on Website ({{ live_products|length }} products)</h3>
    </div>
    <div class="card-body p-0">
        {% if live_products %}
        <p style="padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">
            <strong>These products are visible on your public website.</strong> Customers can see them, add to cart, and inquire.
        </p>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Type</th>
                    <th>Image</th>
                    <th>Website Price</th>
                    <th>Featured</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in live_products %}
                {% set inventory = item.get_inventory_item() %}
                <tr>
                    <td class="font-medium">{{ inventory.item_name if inventory else 'Unknown' }}</td>
                    <td><span class="badge badge-{{ 'primary' if item.product_type == 'boutique' else 'secondary' }}">{{ item.product_type|title }}</span></td>
                    <td>
                        {% if item.image_url %}
                        <img src="{{ item.image_url }}" alt="" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
                        {% elif inventory and inventory.image_url %}
                        <img src="{{ inventory.image_url }}" alt="" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
                        {% else %}
                        <span style="color:#9ca3af;font-size:11px;">No image</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.public_price %}
                        UGX {{ "{:,.0f}".format(item.public_price) }}
                        <span style="font-size:11px;color:#9ca3af;">(custom)</span>
                        {% elif inventory %}
                        UGX {{ "{:,.0f}".format(inventory.min_selling_price) }}
                        {% endif %}
                    </td>
                    <td>
                        {% if item.is_featured %}
                        <span class="text-amber-500">‚òÖ Featured</span>
                        {% else %}
                        <span class="text-gray-400">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="white-space:nowrap;">
                        <button type="button" class="text-blue-600 hover:underline text-sm"
                            onclick="openEditModal({{ item.id }}, '{{ (inventory.item_name if inventory else 'Unknown')|replace("'", "\\'") }}', '{{ item.product_type }}', {{ item.public_price or (inventory.min_selling_price if inventory else 0) }}, {{ 'true' if item.is_featured else 'false' }}, true)">Edit</button>
                        <form action="{{ url_for('website.unpublish_product', id=item.id) }}" method="POST" class="inline">
                            <button type="submit" class="text-orange-600 hover:underline text-sm ml-2"
                                onclick="return confirm('Remove this product from the public website?')">Remove</button>
                        </form>
                        <form action="{{ url_for('website.delete_published_product', id=item.id) }}" method="POST" class="inline">
                            <button type="submit" class="text-red-600 hover:underline text-sm ml-2"
                                onclick="return confirm('Permanently delete this published record? The inventory item will NOT be affected.')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="padding: 40px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
            <p style="font-weight: 600; margin-bottom: 8px;">No Products Published Yet</p>
            <p style="color: #6b7280;">Select products from your inventory below to make them visible on your website</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Removed / Unpublished Products -->
{% if removed_products %}
<div class="card mb-8">
    <div class="card-header" style="background: #fefce8; border-bottom: 1px solid #fcd34d;">
        <h3 style="color: #854d0e;">‚è∏ Removed from Website ({{ removed_products|length }})</h3>
    </div>
    <div class="card-body p-0">
        <p style="padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">
            <strong>These products were previously published but are currently hidden.</strong> You can republish, edit, or permanently delete them.
        </p>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Type</th>
                    <th>Image</th>
                    <th>Last Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in removed_products %}
                {% set inventory = item.get_inventory_item() %}
                <tr>
                    <td class="font-medium">{{ inventory.item_name if inventory else 'Unknown' }}</td>
                    <td><span class="badge badge-{{ 'primary' if item.product_type == 'boutique' else 'secondary' }}">{{ item.product_type|title }}</span></td>
                    <td>
                        {% if item.image_url %}
                        <img src="{{ item.image_url }}" alt="" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
                        {% else %}
                        <span style="color:#9ca3af;font-size:11px;">No image</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.public_price %}
                        UGX {{ "{:,.0f}".format(item.public_price) }}
                        {% elif inventory %}
                        UGX {{ "{:,.0f}".format(inventory.min_selling_price) }}
                        {% endif %}
                    </td>
                    <td style="white-space:nowrap;">
                        <form action="{{ url_for('website.republish_product', id=item.id) }}" method="POST" class="inline">
                            <button type="submit" class="text-green-600 hover:underline text-sm font-semibold">Republish</button>
                        </form>
                        <button type="button" class="text-blue-600 hover:underline text-sm ml-2"
                            onclick="openEditModal({{ item.id }}, '{{ (inventory.item_name if inventory else 'Unknown')|replace("'", "\\'") }}', '{{ item.product_type }}', {{ item.public_price or (inventory.min_selling_price if inventory else 0) }}, {{ 'true' if item.is_featured else 'false' }}, false)">Edit</button>
                        <form action="{{ url_for('website.delete_published_product', id=item.id) }}" method="POST" class="inline">
                            <button type="submit" class="text-red-600 hover:underline text-sm ml-2"
                                onclick="return confirm('Permanently delete this record? You can always re-publish from inventory.')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Boutique Inventory -->
<div class="card mb-8">
    <div class="card-header" style="background: #fdf4ff; border-bottom: 1px solid #e879f9;">
        <h3 style="color: #86198f;">üëó Boutique Inventory</h3>
    </div>
    <div class="card-body p-0">
        <p
            style="padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">
            <strong>Your fashion items.</strong> Click "Publish" to make any item visible on the public website.
        </p>
        {% if boutique_items %}
        <table class="table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Internal Price</th>
                    <th>Stock</th>
                    <th>Website Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in boutique_items %}
                {% set is_published = ('boutique', item.id) in published_ids %}
                <tr>
                    <td class="font-medium">{{ item.item_name }}</td>
                    <td>{{ item.category.name if item.category else 'Uncategorized' }}</td>
                    <td>UGX {{ "{:,.0f}".format(item.min_selling_price) }}</td>
                    <td>{{ item.quantity }} {{ item.unit }}</td>
                    <td>
                        {% if is_published %}
                        <span class="badge badge-success">‚úì On Website</span>
                        {% else %}
                        <span class="badge badge-secondary">Not on Website</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if not is_published %}
                        <button type="button" class="btn btn-sm btn-primary"
                            onclick="openPublishModal('boutique', {{ item.id }}, '{{ item.item_name|replace("'", "\\'") }}', {{ item.min_selling_price }})">
                            üì§ Publish
                        </button>
                        {% else %}
                        <span class="text-green-600 text-xs font-semibold">‚úì Published</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="p-6 text-gray-500 text-center">No boutique items in inventory. Add items in the Boutique section
            first.</p>
        {% endif %}
    </div>
</div>

<!-- Hardware Inventory -->
<div class="card mb-8">
    <div class="card-header" style="background: #fefce8; border-bottom: 1px solid #facc15;">
        <h3 style="color: #854d0e;">üîß Hardware Inventory</h3>
    </div>
    <div class="card-body p-0">
        <p
            style="padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">
            <strong>Your building materials and tools.</strong> Click "Publish" to make any item visible on the public
            website.
        </p>
        {% if hardware_items %}
        <table class="table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Internal Price</th>
                    <th>Stock</th>
                    <th>Website Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in hardware_items %}
                {% set is_published = ('hardware', item.id) in published_ids %}
                <tr>
                    <td class="font-medium">{{ item.item_name }}</td>
                    <td>{{ item.category.name if item.category else 'Uncategorized' }}</td>
                    <td>UGX {{ "{:,.0f}".format(item.min_selling_price) }}</td>
                    <td>{{ item.quantity }} {{ item.unit }}</td>
                    <td>
                        {% if is_published %}
                        <span class="badge badge-success">‚úì On Website</span>
                        {% else %}
                        <span class="badge badge-secondary">Not on Website</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if not is_published %}
                        <button type="button" class="btn btn-sm btn-primary"
                            onclick="openPublishModal('hardware', {{ item.id }}, '{{ item.item_name|replace("'", "\\'") }}', {{ item.min_selling_price }})">
                            üì§ Publish
                        </button>
                        {% else %}
                        <span class="text-green-600 text-xs font-semibold">‚úì Published</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="p-6 text-gray-500 text-center">No hardware items in inventory. Add items in the Hardware section
            first.</p>
        {% endif %}
    </div>
</div>

<!-- Publish Modal -->
<div id="publishModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>üì§ Publish Product to Website</h3>
            <button onclick="closePublishModal()" class="modal-close">&times;</button>
        </div>
        <form action="{{ url_for('website.publish_product') }}" method="POST">
            <input type="hidden" name="product_type" id="modal_product_type">
            <input type="hidden" name="product_id" id="modal_product_id">

            <div class="modal-body">
                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="font-size: 13px; color: #0369a1; margin-bottom: 4px;">You are publishing:</p>
                    <p style="font-size: 18px; font-weight: 600;" id="modal_product_name"></p>
                </div>

                <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #166534;">
                    üì∏ <strong>Image:</strong> The product image from Stock Management will be used. To change the image, go to Edit Stock Item first.
                </div>

                <!-- Price -->
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">üíµ Website Price</label>
                    <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                        Current internal price: <strong id="modal_current_price"></strong>
                    </p>
                    <input type="number" name="public_price" id="modal_public_price" class="form-input" step="100"
                        placeholder="Leave empty to use the internal price">
                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        Want to show a different price on the website? Enter it here. Otherwise, leave empty.
                    </p>
                </div>

                <!-- Featured -->
                <div class="form-group" style="background: #fefce8; padding: 16px; border-radius: 8px; margin-top: 20px;">
                    <label class="flex items-center gap-3" style="cursor: pointer;">
                        <input type="checkbox" name="is_featured" style="width: 20px; height: 20px;">
                        <div>
                            <span style="font-weight: 600;">‚≠ê Mark as Featured Product</span>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                Featured products appear prominently on the homepage
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePublishModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="background: #16a34a;">‚úì Publish to Website</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Published Product Modal -->
<div id="editModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 560px;">
        <div class="modal-header">
            <h3>‚úèÔ∏è Edit Published Product</h3>
            <button onclick="closeEditModal()" class="modal-close">&times;</button>
        </div>
        <form id="editForm" method="POST">
            <div class="modal-body">
                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="font-size: 13px; color: #0369a1; margin-bottom: 4px;">Editing:</p>
                    <p style="font-size: 18px; font-weight: 600;" id="edit_product_name"></p>
                </div>

                <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #166534;">
                    üì∏ <strong>Image:</strong> To change the product image, use Edit Stock Item in the Boutique or Hardware section.
                </div>

                <!-- Price -->
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">üíµ Website Price</label>
                    <input type="number" name="public_price" id="edit_public_price" class="form-input" step="100"
                        placeholder="Leave empty to use internal price">
                </div>

                <!-- Featured -->
                <div class="form-group" style="background: #fefce8; padding: 16px; border-radius: 8px; margin-top: 20px;">
                    <label class="flex items-center gap-3" style="cursor: pointer;">
                        <input type="checkbox" name="is_featured" id="edit_is_featured" style="width: 20px; height: 20px;">
                        <div>
                            <span style="font-weight: 600;">‚≠ê Mark as Featured Product</span>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Featured products appear prominently on the homepage</p>
                        </div>
                    </label>
                </div>

                <!-- Republish option (shown only for removed items) -->
                <div id="edit_republish_section" class="form-group" style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-top: 20px; display:none;">
                    <label class="flex items-center gap-3" style="cursor: pointer;">
                        <input type="checkbox" name="republish" id="edit_republish" style="width: 20px; height: 20px;" checked>
                        <div>
                            <span style="font-weight: 600; color: #166534;">üîÑ Also republish to website</span>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">This item is currently removed. Check to make it live again.</p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function openPublishModal(type, id, name, price) {
        document.getElementById('modal_product_type').value = type;
        document.getElementById('modal_product_id').value = id;
        document.getElementById('modal_product_name').textContent = name;
        document.getElementById('modal_current_price').textContent = 'UGX ' + price.toLocaleString();
        document.getElementById('modal_public_price').value = '';
        document.getElementById('publishModal').style.display = 'flex';
    }

    function closePublishModal() {
        document.getElementById('publishModal').style.display = 'none';
    }

    function openEditModal(id, name, type, price, isFeatured, isLive) {
        document.getElementById('editForm').action = '/website/products/edit/' + id;
        document.getElementById('edit_product_name').textContent = name;
        document.getElementById('edit_public_price').value = price > 0 ? price : '';
        document.getElementById('edit_is_featured').checked = isFeatured;

        // Show republish option only for removed items
        var republishSection = document.getElementById('edit_republish_section');
        if (isLive) {
            republishSection.style.display = 'none';
        } else {
            republishSection.style.display = 'block';
        }

        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
</script>
<style>
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
    }

    .modal-header h3 {
        font-size: 18px;
        font-weight: 600;
    }

    .modal-close {
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: #6b7280;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        position: sticky;
        bottom: 0;
        background: white;
    }
</style>
{% endblock %}