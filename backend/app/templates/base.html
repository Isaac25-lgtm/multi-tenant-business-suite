<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Denove APS{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>

<body class="app-shell" data-section="{{ current_section or 'guest' }}">

    {% if current_user %}
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            {% if current_section == 'manager' %}
            <a href="{{ url_for('dashboard.index') }}" class="brand-link brand-lockup">
                {% elif current_section == 'boutique' %}
                <a href="{{ url_for('boutique.index') }}" class="brand-link brand-lockup">
                    {% elif current_section == 'hardware' %}
                    <a href="{{ url_for('hardware.index') }}" class="brand-link brand-lockup">
                        {% elif current_section == 'finance' %}
                        <a href="{{ url_for('finance.index') }}" class="brand-link brand-lockup">
                            {% else %}
                            <a href="{{ url_for('auth.login') }}" class="brand-link brand-lockup">
                                {% endif %}
                                <img src="{{ url_for('static', filename='images/denovo.png') }}" alt="Denove"
                                    class="brand-logo">
                                <div class="brand-stack">
                                    <h1 class="brand-name">Denove</h1>
                                    <span class="brand-tag">Premium</span>
                                </div>
                            </a>
        </div>

        <nav class="nav-section">
            {% if current_section == 'manager' %}
            <!-- Manager sees all navigation -->
            <p class="nav-label">General</p>
            <a href="{{ url_for('dashboard.index') }}"
                class="nav-item {% if request.endpoint and request.endpoint == 'dashboard.index' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Dashboard
            </a>

            <p class="nav-label">Operations</p>
            <a href="{{ url_for('boutique.index') }}"
                class="nav-item {% if request.endpoint and 'boutique' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Boutique POS
            </a>
            <a href="{{ url_for('hardware.index') }}"
                class="nav-item {% if request.endpoint and 'hardware' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                </svg>
                Hardware Store
            </a>
            <a href="{{ url_for('finance.index') }}"
                class="nav-item {% if request.endpoint and 'finance' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Microfinance
            </a>

            <p class="nav-label">Support</p>
            <a href="{{ url_for('customers.index') }}"
                class="nav-item {% if request.endpoint and 'customers' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Customers
            </a>
            <a href="{{ url_for('dashboard.users') }}"
                class="nav-item {% if request.endpoint and 'users' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                Users
            </a>
            <a href="{{ url_for('dashboard.audit_trail') }}"
                class="nav-item {% if request.endpoint and 'audit' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Audit Trail
            </a>
            <a href="{{ url_for('website.dashboard') }}"
                class="nav-item {% if request.endpoint and 'website' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
                Website Management
            </a>

            {% elif current_section == 'boutique' %}
            <p class="nav-label">Boutique</p>
            <a href="{{ url_for('boutique.index') }}"
                class="nav-item {% if request.endpoint == 'boutique.index' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Overview
            </a>
            <a href="{{ url_for('boutique.stock') }}"
                class="nav-item {% if request.endpoint == 'boutique.stock' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                Stock
            </a>
            <a href="{{ url_for('boutique.sales') }}"
                class="nav-item {% if 'sale' in (request.endpoint or '') %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Sales
            </a>
            <a href="{{ url_for('boutique.hires') }}"
                class="nav-item {% if 'hire' in (request.endpoint or '') %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Hires
            </a>
            <a href="{{ url_for('boutique.credits') }}"
                class="nav-item {% if request.endpoint == 'boutique.credits' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                Credits
            </a>
            <p class="nav-label" style="margin-top:12px">Online</p>
            <a href="{{ url_for('website.dashboard') }}"
                class="nav-item {% if request.endpoint and 'website' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
                Website
            </a>

            {% elif current_section == 'hardware' %}
            <p class="nav-label">Hardware</p>
            <a href="{{ url_for('hardware.index') }}"
                class="nav-item {% if request.endpoint == 'hardware.index' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Overview
            </a>
            <a href="{{ url_for('hardware.stock') }}"
                class="nav-item {% if request.endpoint == 'hardware.stock' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                Stock
            </a>
            <a href="{{ url_for('hardware.sales') }}"
                class="nav-item {% if 'sale' in (request.endpoint or '') %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Sales
            </a>
            <a href="{{ url_for('hardware.credits') }}"
                class="nav-item {% if request.endpoint == 'hardware.credits' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                Credits
            </a>
            <p class="nav-label" style="margin-top:12px">Online</p>
            <a href="{{ url_for('website.dashboard') }}"
                class="nav-item {% if request.endpoint and 'website' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
                Website
            </a>

            {% elif current_section == 'finance' %}
            <p class="nav-label">Finance</p>
            <a href="{{ url_for('finance.index') }}"
                class="nav-item {% if request.endpoint == 'finance.index' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Overview
            </a>
            <a href="{{ url_for('finance.loans') }}"
                class="nav-item {% if 'loan' in (request.endpoint or '') and 'group' not in (request.endpoint or '') %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Individual Loans
            </a>
            <a href="{{ url_for('finance.group_loans') }}"
                class="nav-item {% if 'group_loan' in (request.endpoint or '') %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Group Loans
            </a>
            <a href="{{ url_for('finance.clients') }}"
                class="nav-item {% if request.endpoint == 'finance.clients' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Clients
            </a>
            <a href="{{ url_for('finance.payments') }}"
                class="nav-item {% if request.endpoint == 'finance.payments' %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Payments
            </a>
            <p class="nav-label" style="margin-top:12px">Online</p>
            <a href="{{ url_for('website.dashboard') }}"
                class="nav-item {% if request.endpoint and 'website' in request.endpoint %}active{% endif %}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
                Website
            </a>
            {% endif %}
        </nav>

        <div class="user-footer">
            <div class="user-card">
                <div class="avatar">
                    <span>{{ (current_user or 'U')[0]|upper }}</span>
                </div>
                <div class="user-info">
                    <span class="name">{{ current_user }}</span>
                    <span class="role">{{ current_section|title }}</span>
                </div>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="sidebar-logout">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
            </a>
        </div>
    </aside>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    {% endif %}

    <!-- MAIN CONTENT -->
    <main class="main-content" {% if not current_user %}style="margin-left:0" {% endif %}>
        {% if current_user %}
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleSidebar()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <div class="page-title-bar">
                    {% block page_header %}{% endblock %}
                </div>
            </div>
            <div class="top-bar-right">
                <span style="font-size:13px;color:var(--navy-400);">{{ current_user }} &middot; {{ current_section|title
                    }}</span>
            </div>
        </header>
        {% endif %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">
                {% if category == 'error' %}
                <svg style="width:20px;height:20px;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {% elif category == 'success' %}
                <svg style="width:20px;height:20px;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {% else %}
                <svg style="width:20px;height:20px;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {% endif %}
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Page Content -->
        <div class="page-body">
            {% block content %}{% endblock %}
        </div>

        <!-- Footer -->
        <footer class="footer-main">
            <p>Denove APS &mdash; Premium Business Suite</p>
        </footer>
    </main>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block extra_js %}{% endblock %}

    {% if current_user %}
    <!-- ORDER NOTIFICATION POPUP -->
    <div id="order-notify-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center;">
      <div id="order-notify-card" style="background:#fff;border-radius:16px;width:90%;max-width:560px;max-height:80vh;overflow-y:auto;padding:32px;box-shadow:0 25px 60px rgba(0,0,0,.3);animation:notifyPulse 2s infinite;position:relative;">
        <button onclick="dismissNotify()" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:48px;margin-bottom:8px;">&#128276;</div>
          <h2 id="notify-title" style="font-size:24px;font-weight:800;color:#dc2626;margin:0;">NEW ONLINE ORDER!</h2>
          <p id="notify-subtitle" style="color:#666;font-size:14px;margin-top:4px;"></p>
        </div>
        <div id="notify-orders-list"></div>
        <div style="display:flex;gap:12px;margin-top:20px;">
          <a id="notify-view-btn" href="/website/order-requests" style="flex:1;text-align:center;padding:12px;background:#dc2626;color:#fff;border-radius:10px;text-decoration:none;font-weight:600;font-size:15px;">View Orders</a>
          <button onclick="dismissNotify()" style="flex:1;padding:12px;background:#f3f4f6;color:#374151;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:15px;">Dismiss</button>
        </div>
      </div>
    </div>
    <style>
      @keyframes notifyPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220,38,38,.4), 0 25px 60px rgba(0,0,0,.3); }
        50% { box-shadow: 0 0 0 12px rgba(220,38,38,0), 0 25px 60px rgba(0,0,0,.3); }
      }
      .notify-order-item {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 10px;
      }
      .notify-order-item h4 { margin: 0 0 4px; font-size: 16px; color: #1f2937; }
      .notify-order-item p { margin: 2px 0; font-size: 13px; color: #6b7280; }
      .notify-order-item .notify-total { font-size: 18px; font-weight: 700; color: #dc2626; }
    </style>
    <script>
    (function() {
      var POLL_INTERVAL = 15000;
      var lastCheck = localStorage.getItem('_notifyLastCheck') || new Date().toISOString();
      var notifyTimeout = null;

      function playBeep() {
        try {
          var ctx = new (window.AudioContext || window.webkitAudioContext)();
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = 880;
          osc.type = 'square';
          gain.gain.value = 0.3;
          osc.start();
          osc.stop(ctx.currentTime + 0.2);
          setTimeout(function() {
            var osc2 = ctx.createOscillator();
            var gain2 = ctx.createGain();
            osc2.connect(gain2);
            gain2.connect(ctx.destination);
            osc2.frequency.value = 1100;
            osc2.type = 'square';
            gain2.gain.value = 0.3;
            osc2.start();
            osc2.stop(ctx.currentTime + 0.3);
          }, 250);
        } catch(e) {}
      }

      function showNotifyPopup(orders) {
        var overlay = document.getElementById('order-notify-overlay');
        var list = document.getElementById('notify-orders-list');
        var subtitle = document.getElementById('notify-subtitle');
        subtitle.textContent = orders.length + ' new order' + (orders.length > 1 ? 's' : '') + ' received';
        list.innerHTML = '';
        orders.forEach(function(o) {
          var items = (o.items || []).map(function(i) { return i.name + ' x' + (i.quantity || 1); }).join(', ');
          var total = Number(o.total_amount || 0).toLocaleString('en', {maximumFractionDigits: 0});
          var div = document.createElement('div');
          div.className = 'notify-order-item';
          div.innerHTML = '<h4>' + (o.customer_name || 'Customer') + '</h4>' +
            '<p>' + (o.customer_phone || '') + '</p>' +
            '<p style="margin-top:4px;">' + items + '</p>' +
            '<div class="notify-total" style="margin-top:6px;">UGX ' + total + '</div>';
          list.appendChild(div);
        });
        overlay.style.display = 'flex';
        playBeep();
        clearTimeout(notifyTimeout);
        notifyTimeout = setTimeout(dismissNotify, 60000);
      }

      window.dismissNotify = function() {
        document.getElementById('order-notify-overlay').style.display = 'none';
        clearTimeout(notifyTimeout);
      };

      function pollOrders() {
        fetch('/website/api/new-orders?since=' + encodeURIComponent(lastCheck))
          .then(function(r) { return r.ok ? r.json() : null; })
          .then(function(data) {
            if (data && data.count > 0) {
              showNotifyPopup(data.orders);
            }
            lastCheck = new Date().toISOString();
            localStorage.setItem('_notifyLastCheck', lastCheck);
          })
          .catch(function() {});
      }

      // Start polling
      setTimeout(pollOrders, 3000);
      setInterval(pollOrders, POLL_INTERVAL);
    })();
    </script>
    {% endif %}
</body>

</html>